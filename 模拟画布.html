<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŸºå› å·¥ç¨‹ç”»å¸ƒ</title>
    <style>
        /* åŸºç¡€è®¾ç½® - å¹³æ¿ä¼˜åŒ– */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', sans-serif;
            background-color: #f5f7fa;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* æ ¸å¿ƒç”»å¸ƒ */
        #canvas {
            flex: 1;
            position: relative;
            background-color: #ffffff;
            background-image: 
                linear-gradient(rgba(220, 220, 220, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(220, 220, 220, 0.15) 1px, transparent 1px);
            background-size: 30px 30px;
            overflow: hidden;
            touch-action: none;
            width: 100%;
            height: 100%;
        }

        /* æ¸…ç©ºæŒ‰é’® - å³ä¸‹è§’ */
        .clear-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #dc3545;
            border-radius: 30px;
            color: #dc3545;
            font-size: 26px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .clear-btn:active {
            background: #dc3545;
            color: white;
            transform: scale(0.95);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        /* ç”»å¸ƒå…ƒç´  */
        .canvas-item {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 120px;
            z-index: 10;
            transition: transform 0.15s ease;
            touch-action: none;
            user-select: none;
        }

        .canvas-item.dragging {
            opacity: 0.85;
            z-index: 1000;
            transform: scale(1.05);
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.2));
        }

        /* æ–‡æœ¬æ¡†ç»„ä»¶ - å¯è°ƒæ•´å¤§å° */
        .text-wrapper {
            position: absolute;
            min-width: 160px;
            min-height: 80px;
            background: white;
            border: 2px solid #6c757d;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow: hidden;
            touch-action: none;
            resize: none;
        }

        .text-wrapper.selected {
            border-color: #007bff;
            box-shadow: 0 8px 24px rgba(0, 123, 255, 0.2);
        }

        .text-handle {
            height: 32px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            cursor: move;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            min-height: 44px;
            user-select: none;
        }

        .text-handle:active {
            background: #e9ecef;
        }

        .text-handle::after {
            content: 'â‹®â‹®â‹®';
            color: #6c757d;
            font-size: 18px;
            letter-spacing: 4px;
        }

        .text-area {
            border: none;
            outline: none;
            padding: 15px;
            width: 100%;
            height: 100%;
            font-family: inherit;
            font-size: 18px;
            color: #333;
            resize: none;
            background: transparent;
            line-height: 1.5;
            flex-grow: 1;
            -webkit-user-select: text;
            user-select: text;
            touch-action: auto;
            overflow: auto;
        }

        /* æ–‡æœ¬æ¡†è°ƒæ•´å¤§å°æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #007bff;
            border-radius: 50%;
            cursor: nwse-resize;
            z-index: 1001;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            bottom: -10px;
            right: -10px;
        }

        .text-wrapper.selected .resize-handle {
            display: block;
        }

        .resize-handle:active {
            background: #0056b3;
            transform: scale(1.2);
        }

        /* åº•éƒ¨å·¥å…·æ  */
        .dock {
            height: 170px;
            background: #ffffff;
            border-top: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            z-index: 200;
            padding: 0 20px;
            overflow-x: auto;
            overflow-y: hidden;
            flex-shrink: 0;
            scrollbar-width: none;
        }

        .dock::-webkit-scrollbar {
            display: none;
        }

        /* åˆ é™¤åŒºåŸŸ */
        .delete-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(220, 53, 69, 0.12);
            border-top: 4px solid #dc3545;
            display: none;
            align-items: center;
            justify-content: center;
            color: #dc3545;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            backdrop-filter: blur(4px);
            z-index: 20;
        }

        /* å·¥å…·é¡¹ */
        .dock-item {
            width: 90px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 12px;
            border-radius: 12px;
            position: relative;
            flex-shrink: 0;
            touch-action: manipulation;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .dock-item:active {
            background: #e9ecef;
            transform: scale(0.95);
            border-color: #007bff;
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.15);
        }

        /* å›¾æ ‡æ ·å¼ */
        .icon-svg {
            width: 75px;
            height: 75px;
            pointer-events: none;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.1));
        }

        /* å…ƒç´ æ ‡ç­¾ */
        .item-label {
            margin-top: 8px;
            font-size: 14px;
            color: #495057;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 12px;
            border-radius: 12px;
            pointer-events: none;
            white-space: nowrap;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .dock-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 8px;
            pointer-events: none;
            font-weight: 600;
            text-align: center;
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .selected {
            outline: 3px solid #007bff;
            outline-offset: 3px;
            border-radius: 8px;
        }

        /* åŒæŒ‡ç¼©æ”¾æç¤º */
        .pinch-hint {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #007bff;
            border-radius: 16px;
            padding: 12px 20px;
            font-size: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 400;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .pinch-hint.show {
            opacity: 1;
        }

        /* æ—‹è½¬æ‰‹æŸ„ */
        .rotate-handle {
            position: absolute;
            width: 22px;
            height: 22px;
            background: #ff9800;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
        }

        .selected .rotate-handle {
            display: block;
        }
    </style>
</head>
<body>

<div id="canvas">
    <button class="clear-btn" onclick="clearCanvas()" ontouchstart="clearCanvas()">ğŸ—‘ï¸</button>
    
    <div class="pinch-hint" id="pinchHint">
        <span>ğŸ¤</span> åŒæŒ‡æåˆå¯ç¼©æ”¾
    </div>
</div>

<div class="dock" id="dock">
    <div class="delete-overlay" id="delZone">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
            <div style="font-size: 40px;">ğŸ—‘ï¸</div>
            <div style="font-size: 22px;">æ¾å¼€åˆ é™¤</div>
        </div>
    </div>

    <div class="dock-item" ontouchstart="spawnItem(event, 'plasmid')" onmousedown="spawnItem(event, 'plasmid')">
        <svg class="icon-svg" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="none" stroke="#333" stroke-width="6" />
            <path d="M 50 10 A 40 40 0 0 1 80 23" fill="none" stroke="#dc3545" stroke-width="6" />
            <path d="M 20 80 A 40 40 0 0 1 10 50" fill="none" stroke="#28a745" stroke-width="6" />
            <path d="M 90 50 A 40 40 0 0 1 80 77" fill="none" stroke="#007bff" stroke-width="6" />
        </svg>
        <span class="dock-label">è´¨ç²’</span>
    </div>

    <div class="dock-item" ontouchstart="spawnItem(event, 'coli')" onmousedown="spawnItem(event, 'coli')">
        <svg class="icon-svg" viewBox="0 0 100 100">
            <rect x="25" y="35" width="50" height="30" rx="15" fill="#ffc107" stroke="#e0a800" stroke-width="3" />
            <path d="M 75 50 Q 95 40 98 60" fill="none" stroke="#e0a800" stroke-width="3" />
        </svg>
        <span class="dock-label">å¤§è‚ æ†èŒ</span>
    </div>

    <div class="dock-item" ontouchstart="spawnItem(event, 'dish')" onmousedown="spawnItem(event, 'dish')">
        <svg class="icon-svg" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="#fff8e1" stroke="#ced4da" stroke-width="2" />
            <circle cx="50" cy="50" r="40" fill="none" stroke="#e9ecef" stroke-width="1" />
            <circle cx="30" cy="40" r="3" fill="#fd7e14" />
            <circle cx="60" cy="30" r="4" fill="#fd7e14" />
            <circle cx="50" cy="70" r="3" fill="#fd7e14" />
            <circle cx="70" cy="60" r="5" fill="#fd7e14" />
        </svg>
        <span class="dock-label">åŸ¹å…»åŸº</span>
    </div>

    <div class="dock-item" ontouchstart="spawnItem(event, 'cho')" onmousedown="spawnItem(event, 'cho')">
        <svg class="icon-svg" viewBox="0 0 100 100">
            <defs>
                <radialGradient id="g1" cx="50%" cy="50%" r="50%" fx="40%" fy="40%">
                    <stop offset="0%" style="stop-color:#80deea;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#0097a7;stop-opacity:1" />
                </radialGradient>
            </defs>
            <circle cx="50" cy="50" r="42" fill="url(#g1)" stroke="#00acc1" stroke-width="1"/>
            <circle cx="50" cy="50" r="14" fill="#e0f7fa" opacity="0.6" />
            <circle cx="50" cy="50" r="6" fill="#006064" />
        </svg>
        <span class="dock-label">CHO ç»†èƒ</span>
    </div>

    <div class="dock-item" ontouchstart="spawnItem(event, 'arrow')" onmousedown="spawnItem(event, 'arrow')">
        <div style="font-size: 50px; color: #6c757d; font-weight: 900; pointer-events: none;">â¡</div>
        <span class="dock-label">ç®­å¤´</span>
    </div>

    <div class="dock-item" ontouchstart="spawnItem(event, 'text')" onmousedown="spawnItem(event, 'text')">
        <div style="width:55px; height:35px; border:3px dashed #adb5bd; border-radius:8px; display:flex; justify-content:center; align-items:center; color:#6c757d; font-weight:bold; font-size:16px;">Aa</div>
        <span class="dock-label">æ–‡æœ¬æ¡†</span>
    </div>
</div>

<script>
    // çŠ¶æ€ç®¡ç†
    const state = {
        draggingEl: null,
        startX: 0,
        startY: 0,
        startLeft: 0,
        startTop: 0,
        selectedEl: null,
        isTouchDevice: false,
        resizeMode: false,
        startWidth: 0,
        startHeight: 0
    };

    // æ£€æµ‹è§¦æ‘¸è®¾å¤‡
    function detectTouchDevice() {
        state.isTouchDevice = ('ontouchstart' in window) || 
                              (navigator.maxTouchPoints > 0);
        
        if (state.isTouchDevice) {
            // æ˜¾ç¤ºåŒæŒ‡ç¼©æ”¾æç¤º
            setTimeout(() => {
                const hint = document.getElementById('pinchHint');
                hint.classList.add('show');
                setTimeout(() => hint.classList.remove('show'), 4000);
            }, 1000);
        }
    }

    // HTMLæ¨¡æ¿
    function getHTML(type, id) {
        switch(type) {
            case 'plasmid': 
                return `<svg class="icon-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="#333" stroke-width="6" /><path d="M 50 10 A 40 40 0 0 1 80 23" fill="none" stroke="#dc3545" stroke-width="6" /><path d="M 20 80 A 40 40 0 0 1 10 50" fill="none" stroke="#28a745" stroke-width="6" /><path d="M 90 50 A 40 40 0 0 1 80 77" fill="none" stroke="#007bff" stroke-width="6" /></svg><span class="item-label">è´¨ç²’</span><div class="rotate-handle"></div>`;
            case 'coli': 
                return `<svg class="icon-svg" viewBox="0 0 100 100"><rect x="25" y="35" width="50" height="30" rx="15" fill="#ffc107" stroke="#e0a800" stroke-width="3" /><path d="M 75 50 Q 95 40 98 60" fill="none" stroke="#e0a800" stroke-width="3" /></svg><span class="item-label">å¤§è‚ æ†èŒ</span><div class="rotate-handle"></div>`;
            case 'dish': 
                return `<svg class="icon-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#fff8e1" stroke="#ced4da" stroke-width="2" /><circle cx="50" cy="50" r="40" fill="none" stroke="#e9ecef" stroke-width="1" /><circle cx="30" cy="40" r="3" fill="#fd7e14" /><circle cx="60" cy="30" r="4" fill="#fd7e14" /><circle cx="50" cy="70" r="3" fill="#fd7e14" /><circle cx="70" cy="60" r="5" fill="#fd7e14" /></svg><span class="item-label">åŸ¹å…»åŸº</span><div class="rotate-handle"></div>`;
            case 'cho': 
                return `<svg class="icon-svg" viewBox="0 0 100 100"><defs><radialGradient id="g_${id}" cx="50%" cy="50%" r="50%" fx="40%" fy="40%"><stop offset="0%" style="stop-color:#80deea;stop-opacity:1" /><stop offset="100%" style="stop-color:#0097a7;stop-opacity:1" /></radialGradient></defs><circle cx="50" cy="50" r="42" fill="url(#g_${id})" stroke="#00acc1" stroke-width="1"/><circle cx="50" cy="50" r="14" fill="#e0f7fa" opacity="0.6" /><circle cx="50" cy="50" r="6" fill="#006064" /></svg><span class="item-label">CHOç»†èƒ</span><div class="rotate-handle"></div>`;
            case 'arrow': 
                return `<div style="font-size: 60px; color: #6c757d; font-weight: 900; pointer-events: none; transform-origin: center;">â¡</div><span class="item-label">ç®­å¤´</span><div class="rotate-handle"></div>`;
            case 'text': 
                return `<div class="text-handle"></div><textarea class="text-area" placeholder="è¾“å…¥æ–‡æœ¬..."></textarea><div class="resize-handle"></div>`;
        }
    }

    // åˆ›å»ºæ–°å…ƒç´ 
    function spawnItem(e, type) {
        if (e.cancelable) e.preventDefault();
        e.stopPropagation();
        
        // è·å–è§¦æ‘¸ç‚¹æˆ–é¼ æ ‡ç‚¹ä½ç½®
        let clientX, clientY;
        if (e.type === 'touchstart') {
            const touch = e.touches[0];
            clientX = touch.clientX;
            clientY = touch.clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        const canvas = document.getElementById('canvas');
        const id = Date.now();
        const el = document.createElement('div');
        
        if (type === 'text') {
            el.className = 'text-wrapper';
            el.dataset.type = type;
            el.dataset.id = id;
            el.innerHTML = getHTML(type, id);
            
            // æ–‡æœ¬æ¡†æ‰‹æŸ„è§¦æ‘¸äº‹ä»¶
            const handle = el.querySelector('.text-handle');
            handle.addEventListener('touchstart', function(ev) {
                startDrag(ev, el);
            }, { passive: false });
            
            handle.addEventListener('mousedown', function(ev) {
                startDrag(ev, el);
            });
            
            // æ–‡æœ¬æ¡†å¤§å°è°ƒæ•´æ‰‹æŸ„
            const resizeHandle = el.querySelector('.resize-handle');
            resizeHandle.addEventListener('touchstart', function(ev) {
                startResize(ev, el);
            }, { passive: false });
            
            resizeHandle.addEventListener('mousedown', function(ev) {
                startResize(ev, el);
            });
            
            // æ–‡æœ¬æ¡†ç‚¹å‡»èšç„¦
            el.addEventListener('touchend', function(ev) {
                if (ev.target.classList.contains('text-area')) {
                    ev.stopPropagation();
                    ev.target.focus();
                }
            });
            
            // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            el.querySelector('.text-area').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        } else {
            el.className = 'canvas-item';
            el.dataset.type = type;
            el.dataset.id = id;
            el.innerHTML = getHTML(type, id);
            
            // è§¦æ‘¸äº‹ä»¶
            el.addEventListener('touchstart', function(ev) {
                startDrag(ev, el);
            }, { passive: false });
            
            el.addEventListener('mousedown', function(ev) {
                startDrag(ev, el);
            });
            
            // æ—‹è½¬æ‰‹æŸ„äº‹ä»¶
            const rotateHandle = el.querySelector('.rotate-handle');
            if (rotateHandle) {
                rotateHandle.addEventListener('touchstart', function(ev) {
                    startRotate(ev, el);
                }, { passive: false });
                
                rotateHandle.addEventListener('mousedown', function(ev) {
                    startRotate(ev, el);
                });
            }
            
            // åŒæŒ‡ç¼©æ”¾
            addPinchZoom(el);
        }
        
        // ç‚¹å‡»é€‰ä¸­å…ƒç´ 
        el.addEventListener('click', function(ev) {
            if (ev.target.classList.contains('text-handle') || 
                ev.target.classList.contains('resize-handle') ||
                ev.target.classList.contains('rotate-handle')) return;
            selectElement(el);
        });
        
        el.addEventListener('touchend', function(ev) {
            if (ev.target.classList.contains('text-handle') || 
                ev.target.classList.contains('resize-handle') ||
                ev.target.classList.contains('rotate-handle')) return;
            selectElement(el);
        });
        
        // åˆå§‹ä½ç½®
        const canvasRect = canvas.getBoundingClientRect();
        let left = clientX - 60;
        let top = clientY - 60;
        
        // ç¡®ä¿å…ƒç´ åœ¨ç”»å¸ƒå†…
        left = Math.max(canvasRect.left, Math.min(left, canvasRect.right - 120));
        top = Math.max(canvasRect.top, Math.min(top, canvasRect.bottom - 120));
        
        el.style.left = (left - canvasRect.left) + 'px';
        el.style.top = (top - canvasRect.top) + 'px';
        
        canvas.appendChild(el);
        
        // é€‰ä¸­æ–°å…ƒç´ 
        selectElement(el);
        
        // å¼€å§‹æ‹–æ‹½æ–°å…ƒç´ 
        if (type !== 'text') {
            startDrag(e, el);
        }
    }

    // é€‰ä¸­å…ƒç´ 
    function selectElement(el) {
        if (state.selectedEl) {
            state.selectedEl.classList.remove('selected');
        }
        
        state.selectedEl = el;
        el.classList.add('selected');
    }

    // å¼€å§‹æ‹–æ‹½
    function startDrag(e, el) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æ–‡æœ¬æ¡†å†…å®¹ï¼Œä¸å¼€å§‹æ‹–æ‹½
        if (e.target.tagName === 'TEXTAREA') return;
        
        if (e.cancelable) e.preventDefault();
        e.stopPropagation();
        
        state.draggingEl = el;
        state.resizeMode = false;
        el.classList.add('dragging');
        
        // è·å–è§¦æ‘¸ç‚¹æˆ–é¼ æ ‡ç‚¹ä½ç½®
        let clientX, clientY;
        if (e.type === 'touchstart') {
            const touch = e.touches[0];
            clientX = touch.clientX;
            clientY = touch.clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        // ä¿å­˜åˆå§‹ä½ç½®
        state.startX = clientX;
        state.startY = clientY;
        state.startLeft = parseFloat(el.style.left) || 0;
        state.startTop = parseFloat(el.style.top) || 0;
        
        // æ˜¾ç¤ºåˆ é™¤åŒºåŸŸ
        document.getElementById('delZone').style.display = 'flex';
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', onEnd, { passive: false });
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
    }

    // å¼€å§‹è°ƒæ•´å¤§å°ï¼ˆæ–‡æœ¬æ¡†ï¼‰
    function startResize(e, el) {
        if (e.cancelable) e.preventDefault();
        e.stopPropagation();
        
        state.draggingEl = el;
        state.resizeMode = true;
        
        // è·å–è§¦æ‘¸ç‚¹æˆ–é¼ æ ‡ç‚¹ä½ç½®
        let clientX, clientY;
        if (e.type === 'touchstart') {
            const touch = e.touches[0];
            clientX = touch.clientX;
            clientY = touch.clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        // ä¿å­˜åˆå§‹å€¼
        state.startX = clientX;
        state.startY = clientY;
        state.startLeft = parseFloat(el.style.left) || 0;
        state.startTop = parseFloat(el.style.top) || 0;
        state.startWidth = el.offsetWidth;
        state.startHeight = el.offsetHeight;
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬
        document.addEventListener('touchmove', onResize, { passive: false });
        document.addEventListener('touchend', onResizeEnd, { passive: false });
        document.addEventListener('mousemove', onResize);
        document.addEventListener('mouseup', onResizeEnd);
    }

    // å¼€å§‹æ—‹è½¬
    function startRotate(e, el) {
        if (e.cancelable) e.preventDefault();
        e.stopPropagation();
        
        // è·å–å…ƒç´ ä¸­å¿ƒç‚¹
        const rect = el.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        // è·å–è§¦æ‘¸ç‚¹æˆ–é¼ æ ‡ç‚¹ä½ç½®
        let clientX, clientY;
        if (e.type === 'touchstart') {
            const touch = e.touches[0];
            clientX = touch.clientX;
            clientY = touch.clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        // è®¡ç®—åˆå§‹è§’åº¦
        const startAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
        
        // è·å–å½“å‰æ—‹è½¬è§’åº¦
        const transform = el.style.transform || '';
        const match = transform.match(/rotate\(([^)]+)deg\)/);
        const currentAngle = match ? parseFloat(match[1]) : 0;
        
        // æ—‹è½¬å¤„ç†å‡½æ•°
        function onRotate(ev) {
            ev.preventDefault();
            
            let currentX, currentY;
            if (ev.type === 'touchmove') {
                const touch = ev.touches[0];
                currentX = touch.clientX;
                currentY = touch.clientY;
            } else {
                currentX = ev.clientX;
                currentY = ev.clientY;
            }
            
            // è®¡ç®—æ–°è§’åº¦
            const newAngle = Math.atan2(currentY - centerY, currentX - centerX) * 180 / Math.PI;
            const rotation = currentAngle + (newAngle - startAngle);
            
            // åº”ç”¨æ—‹è½¬
            el.style.transform = `rotate(${rotation}deg)`;
        }
        
        function onRotateEnd() {
            document.removeEventListener('touchmove', onRotate);
            document.removeEventListener('touchend', onRotateEnd);
            document.removeEventListener('mousemove', onRotate);
            document.removeEventListener('mouseup', onRotateEnd);
        }
        
        document.addEventListener('touchmove', onRotate, { passive: false });
        document.addEventListener('touchend', onRotateEnd, { passive: false });
        document.addEventListener('mousemove', onRotate);
        document.addEventListener('mouseup', onRotateEnd);
    }

    // ç§»åŠ¨å…ƒç´ 
    function onMove(e) {
        if (!state.draggingEl || state.resizeMode) return;
        
        if (e.cancelable) e.preventDefault();
        
        let clientX, clientY;
        if (e.type === 'touchmove') {
            const touch = e.touches[0];
            clientX = touch.clientX;
            clientY = touch.clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        // è®¡ç®—æ–°ä½ç½®
        const deltaX = clientX - state.startX;
        const deltaY = clientY - state.startY;
        
        const canvas = document.getElementById('canvas');
        const canvasRect = canvas.getBoundingClientRect();
        
        let newLeft = state.startLeft + deltaX;
        let newTop = state.startTop + deltaY;
        
        // é™åˆ¶åœ¨ç”»å¸ƒå†…
        const elRect = state.draggingEl.getBoundingClientRect();
        newLeft = Math.max(0, Math.min(newLeft, canvasRect.width - elRect.width));
        newTop = Math.max(0, Math.min(newTop, canvasRect.height - elRect.height));
        
        // åº”ç”¨æ–°ä½ç½®
        state.draggingEl.style.left = newLeft + 'px';
        state.draggingEl.style.top = newTop + 'px';
        
        // åˆ é™¤åŒºé«˜äº®
        const dockTop = document.getElementById('dock').getBoundingClientRect().top;
        const delZone = document.getElementById('delZone');
        
        if (clientY > dockTop - 100) {
            delZone.style.backgroundColor = 'rgba(220, 53, 69, 0.2)';
            delZone.style.borderColor = '#dc3545';
        } else {
            delZone.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
            delZone.style.borderColor = 'rgba(220, 53, 69, 0.5)';
        }
    }

    // è°ƒæ•´å¤§å°
    function onResize(e) {
        if (!state.draggingEl || !state.resizeMode) return;
        
        if (e.cancelable) e.preventDefault();
        
        let clientX, clientY;
        if (e.type === 'touchmove') {
            const touch = e.touches[0];
            clientX = touch.clientX;
            clientY = touch.clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        // è®¡ç®—å¤§å°å˜åŒ–
        const deltaX = clientX - state.startX;
        const deltaY = clientY - state.startY;
        
        // è®¡ç®—æ–°å¤§å°
        let newWidth = Math.max(160, state.startWidth + deltaX);
        let newHeight = Math.max(80, state.startHeight + deltaY);
        
        // åº”ç”¨æ–°å¤§å°
        state.draggingEl.style.width = newWidth + 'px';
        state.draggingEl.style.height = newHeight + 'px';
    }

    // ç»“æŸè°ƒæ•´å¤§å°
    function onResizeEnd() {
        if (state.draggingEl) {
            state.resizeMode = false;
        }
        
        // ç§»é™¤äº‹ä»¶ç›‘å¬
        document.removeEventListener('touchmove', onResize);
        document.removeEventListener('touchend', onResizeEnd);
        document.removeEventListener('mousemove', onResize);
        document.removeEventListener('mouseup', onResizeEnd);
    }

    // ç»“æŸæ‹–æ‹½
    function onEnd(e) {
        if (!state.draggingEl || state.resizeMode) return;
        
        if (e.cancelable) e.preventDefault();
        
        let clientY;
        if (e.type === 'touchend') {
            const touch = e.changedTouches[0];
            clientY = touch.clientY;
        } else {
            clientY = e.clientY;
        }
        
        const dockTop = document.getElementById('dock').getBoundingClientRect().top;
        
        if (clientY > dockTop - 50) {
            // åˆ é™¤å…ƒç´ 
            const el = state.draggingEl;
            el.style.transition = 'all 0.3s';
            el.style.transform = 'scale(0) rotate(90deg)';
            el.style.opacity = '0';
            
            setTimeout(() => {
                if (el && el.parentNode) {
                    el.remove();
                    if (state.selectedEl === el) {
                        state.selectedEl = null;
                    }
                }
            }, 300);
        } else {
            state.draggingEl.classList.remove('dragging');
        }
        
        state.draggingEl = null;
        document.getElementById('delZone').style.display = 'none';
        
        // ç§»é™¤äº‹ä»¶ç›‘å¬
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onEnd);
    }

    // æ·»åŠ åŒæŒ‡ç¼©æ”¾åŠŸèƒ½
    function addPinchZoom(el) {
        let initialDistance = 0;
        let initialScale = 1;
        let initialRotation = 0;
        
        el.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                // è®¡ç®—åˆå§‹è·ç¦»
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                initialDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                // è·å–å½“å‰å˜æ¢
                const transform = el.style.transform || '';
                const scaleMatch = transform.match(/scale\(([^)]+)\)/);
                initialScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
                
                const rotateMatch = transform.match(/rotate\(([^)]+)deg\)/);
                initialRotation = rotateMatch ? parseFloat(rotateMatch[1]) : 0;
            }
        }, { passive: true });
        
        el.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2 && initialDistance > 0) {
                e.preventDefault();
                
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                const scale = initialScale * (currentDistance / initialDistance);
                
                // è®¡ç®—æ—‹è½¬è§’åº¦
                const deltaX = touch2.clientX - touch1.clientX;
                const deltaY = touch2.clientY - touch1.clientY;
                const currentAngle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                
                // è·å–åˆå§‹è§’åº¦
                const initialTouch1 = e.targetTouches[0];
                const initialTouch2 = e.targetTouches[1];
                
                let rotation = initialRotation;
                if (initialTouch1 && initialTouch2) {
                    const initialDeltaX = initialTouch2.clientX - initialTouch1.clientX;
                    const initialDeltaY = initialTouch2.clientY - initialTouch1.clientY;
                    const initialAngle = Math.atan2(initialDeltaY, initialDeltaX) * 180 / Math.PI;
                    rotation = initialRotation + (currentAngle - initialAngle);
                }
                
                // åº”ç”¨å˜æ¢
                el.style.transform = `scale(${Math.max(0.5, Math.min(scale, 3))}) rotate(${rotation}deg)`;
            }
        }, { passive: false });
        
        el.addEventListener('touchend', function() {
            initialDistance = 0;
        });
    }

    // æ¸…ç©ºç”»å¸ƒ
    function clearCanvas() {
        const items = document.querySelectorAll('.canvas-item, .text-wrapper');
        if (items.length > 0) {
            // æ·»åŠ ç¡®è®¤æç¤º
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å…ƒç´ å—ï¼Ÿ')) {
                items.forEach(el => {
                    el.style.transition = 'all 0.3s';
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0)';
                    setTimeout(() => {
                        if (el.parentNode) el.remove();
                    }, 300);
                });
                
                state.selectedEl = null;
            }
        }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        detectTouchDevice();
        
        // ç‚¹å‡»ç”»å¸ƒç©ºç™½å¤„å–æ¶ˆé€‰æ‹©
        document.getElementById('canvas').addEventListener('click', function(e) {
            if (e.target === this || e.target.classList.contains('clear-btn')) {
                if (state.selectedEl) {
                    state.selectedEl.classList.remove('selected');
                    state.selectedEl = null;
                }
            }
        });
        
        document.getElementById('canvas').addEventListener('touchend', function(e) {
            if (e.target === this || e.target.classList.contains('clear-btn')) {
                if (state.selectedEl) {
                    state.selectedEl.classList.remove('selected');
                    state.selectedEl = null;
                }
            }
        });
        
        // é˜»æ­¢é»˜è®¤çš„æ–‡æœ¬é€‰æ‹©è¡Œä¸º
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
        });
    });
</script>

</body>
</html>